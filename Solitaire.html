<html>
<head>
<title>Solitaire</title>
<style type=text/css>

.Card, .HandName
{
	display:	block;
	margin:		0px;
	padding:	5px;
	width:		18vmin;
	height:		calc( 18vmin * 96 / 71 );
	border:		solid #000 1px;
	text-align:	center;
	overflow:	hidden;
	background-size:	cover;
	background-color: #fff;
}

.HandName
{
	border:		none;
}

.Card
{
	cursor:	hand;
}

.Hand:after
{
	content:	'';
	display:	block;
	clear:		both;
}

body
{
	padding:	0px;
}

.DeckHolder, #DeckTopRow
{
	margin:		1vmin;
	display:	flow-root;
}

.Deck
{
	margin:		1vmin;
	
	float:		left;
	width:		20vmin;
	height:		calc( 20vmin * 96 / 71 );
	background-color: #2C2;
}

#SuitDeckHolder
{
	float:	right;
}

#NewCardDeckHolder
{
	float:	left;
}

</style>
</head>
<body>

<div id=DeckTopRow>
	<div id=NewCardDeckHolder class=DeckHolder>
		<div class=Deck id=NewCardDeck></div>
	</div>

	<div id=SuitDeckHolder class=DeckHolder>
		<div class=Deck id=HeartDeck></div>
		<div class=Deck id=SpadeDeck></div>
		<div class=Deck id=DiamondDeck></div>
		<div class=Deck id=ClubDeck></div>
	</div>
</div>

<div id=ScratchDeckHolder class=DeckHolder>
	<div class=Deck id=ScratchDeck0></div>
	<div class=Deck id=ScratchDeck1></div>
	<div class=Deck id=ScratchDeck2></div>
	<div class=Deck id=ScratchDeck3></div>
	<div class=Deck id=ScratchDeck4></div>
	<div class=Deck id=ScratchDeck5></div>
	<div class=Deck id=ScratchDeck6></div>
</div>

<script>

	function CreateSuit(_Name,_Colour)
	{
		return { Name:_Name, Colour:_Colour };
	}

	var HighestZ = 1;
	var $Red = 'red';
	var $Black = 'black';
	var $Jack = 'Jack';
	var $Queen = 'Queen';
	var $King = 'King';
	var $Ace = 'Ace';
	var $Diamond = CreateSuit('Diamond',$Red);
	var $Heart = CreateSuit('Heart',$Red);
	var $Spade = CreateSuit('Spade',$Black);
	var $Club = CreateSuit('Club',$Black);

	function float2(_x,_y)
	{
		return {x:_x, y:_y };
	}

	function SetElementPosition(Element,x,y)
	{
		Element.style.position = 'absolute';
		Element.style.top = ( y) + "px";
		Element.style.left = ( x) + "px";
	}

	function SetElementToTop(Element)
	{
		HighestZ++;
		Element.style.zIndex = HighestZ;
	}

	function GetElementRect(Element)
	{
		let absolutePosition = GetElementRect;
		let el = Element;
		//	need to cope with scroll, not just getBoundingClientRect :/
		//	https://stackoverflow.com/a/32623832/355753
		let
		found,
		left = 0,
		top = 0,
		width = 0,
		height = 0,
		offsetBase = absolutePosition.offsetBase;
		if (!offsetBase && document.body) {
			offsetBase = absolutePosition.offsetBase = document.createElement('div');
			offsetBase.style.cssText = 'position:absolute;left:0;top:0';
			document.body.appendChild(offsetBase);
		}
		if (el && el.ownerDocument === document && 'getBoundingClientRect' in el && offsetBase) {
			let boundingRect = el.getBoundingClientRect();
			let baseRect = offsetBase.getBoundingClientRect();
			found = true;
			left = boundingRect.left - baseRect.left;
			top = boundingRect.top - baseRect.top;
			width = boundingRect.right - boundingRect.left;
			height = boundingRect.bottom - boundingRect.top;
		}
		return {
			found: found,
			left: left,
			top: top,
			width: width,
			height: height,
			right: left + width,
			bottom: top + height,
			x: left,
			y: top,
			xy: float2(left,top)
		};
	}

	function MakeElementAbsolute(Element)
	{
		if ( Element.style.position == "absolute" )
		{
			//console.log("Already absolute");
			return;
		}
		
		//	get current pos
		let Rect = GetElementRect(Element);
		Element.style.position = "absolute";
		Element.style.left = Rect.left + "px";
		Element.style.top = Rect.top + "px";
		document.body.appendChild(Element);
	}

	function SetElementPosition(Element,x,y)
	{
		MakeElementAbsolute(Element);
		
		//	don't allow element off-window
		let Rect = GetElementRect(Element);
		let ElementWidth = Rect.width;
		let ElementHeight = Rect.height;
		let ScreenSize = float2( Element.parentNode.clientWidth, Element.parentNode.clientHeight );
		let ScreenMin = float2(0,0);
		let ScreenMax = float2(ScreenSize.x - ElementWidth, ScreenSize.y - ElementWidth );
		x = Math.max( ScreenMin.x, x );
		y = Math.max( ScreenMin.y, y );
		x = Math.min( ScreenMax.x, x );
		y = Math.min( ScreenMax.y, y );
		
		Element.style.left = x + "px";
		Element.style.top = y + "px";
	}

	function SetElementParent(Element,Parent)
	{
		//	make absolute (to detatch from current parent)
		MakeElementAbsolute(Element);
	
		//	leave as absolute if body
		if ( Parent == document.body )
			return;
		
		//	make element relative again
		let ParentRect = GetElementRect(Parent);
		let ChildRect = GetElementRect(Element);
		ChildRect.x -= ParentRect.x;
		ChildRect.y -= ParentRect.y;
		Parent.appendChild(Element);
		Element.style.position = "relative";
		Element.style.left = ChildRect.x + "px";
		Element.style.top = ChildRect.y + "px";
		
		console.log( Element.className + " new parent " + Parent.className );
	}

	//	returns [float2].snapPos [function].callback [Element].newParent
	function GetDropCallback(Element)
	{
		//	there is no function for getting all elements under a rect,
		//	so instead we'll check the corners
		//	for now that'll probably be enough, if we get some thin places to drop, may we'll have to check a grid of the rect
		let ElementRect = GetElementRect(Element);
		let Min = float2( ElementRect.x, ElementRect.y );
		let Max = float2( Min.x + ElementRect.width, Min.y + ElementRect.height );
		
		let CheckPositions = [];
		CheckPositions.push( float2(Min.x,Min.y) );
		CheckPositions.push( float2(Min.x,Max.y) );
		CheckPositions.push( float2(Max.x,Max.y) );
		CheckPositions.push( float2(Max.x,Min.y) );
		
		let ShadowElements = [];
		let PushUniqueElement = function(ShadowElement)
		{
			let ExistingIndex = ShadowElements.indexOf( ShadowElement );
			if ( ExistingIndex >= 0 )
				return;
			//	filter droppable
			if ( ShadowElement.GetDropPos == undefined )
				return;
			ShadowElements.push( ShadowElement );
		};
		let EnumElementsUnderPoint = function(Point)
		{
			let PointShadows = document.elementsFromPoint(Point.x,Point.y);
			PointShadows.forEach( PushUniqueElement );
		};
		CheckPositions.forEach( EnumElementsUnderPoint );
		
		//	pick best shadow element
		let DroppableShadowElements = [];
		let UndroppableShadowElements = [];

		let CheckDroppable = function(ShadowElement)
		{
			let DropPos = ShadowElement.GetDropPos(Element);
			if ( DropPos == null )
				UndroppableShadowElements.push( ShadowElement );
			else
				DroppableShadowElements.push( ShadowElement );
		};
		ShadowElements.forEach( CheckDroppable );

		//	todo: sort z somehow
		
		if ( DroppableShadowElements.length > 0 )
		{
			let NewParent = DroppableShadowElements[0];
			let DropPos = NewParent.GetDropPos(Element);
			let DropFunc = NewParent.OnDrop;
			return { snapPos:DropPos, callback:DropFunc, newParent:NewParent };
		}

		if ( UndroppableShadowElements.length > 0 )
		{
			return null;
		}
		
		return null;
	}

	function MakeElementDraggable(Element)
	{
		let OnMouseDrag = function(e)
		{
			e = e || window.event;
			e.preventDefault();
			
			let MouseX = e.clientX;
			let MouseY = e.clientY;
			
			let NewX = MouseX - Element.grabLocalX;
			let NewY = MouseY - Element.grabLocalY;
			SetElementPosition( Element, NewX, NewY );
			
			let Droppable = GetDropCallback(Element);
			if ( Droppable != null )
			{
				//	dont snap if dragging FROM this element
				if ( Element.grabParent != Droppable.newParent )
				{
					//	snap!
					NewX = Droppable.snapPos.x;
					NewY = Droppable.snapPos.y;
				}
			}
			
			SetElementPosition( Element, NewX, NewY );
		};

		let OnMouseUp = function(e)
		{
			OnMouseDrag(e);

			//	drop!
			let Droppable = GetDropCallback(Element);
			if ( Droppable != null )
			{
				console.log("on drop " + Droppable.snapPos.x);
				//	do snap in case we skipped it earlier
				SetElementPosition( Element, Droppable.snapPos.x, Droppable.snapPos.y );
				
				//	do drop
				Droppable.callback(Element);
			}
			else if ( Element.grabParent != null )
			{
				console.log(Element.parentNode.className);
				/*
				console.log("reverting to parent");
				//	revert back to previous parent
				//	Element.grabParent.OnDrop ?
				//	gr: make a "grab from object revert" func
				SetElementParent( Element, Element.grabParent );
				 */
			}
			
			Element.grabParent = null;
			
			Element.onmouseup = null;
			Element.onmousemove = null;
			document.onmouseup = null;
			document.onmousemove = null;
		};

		let OnMouseDown = function(e)
		{
			e = e || window.event;
			e.preventDefault();
			
			//	jump to top
			Element.grabParent = Element.parentNode;
			SetElementToTop(Element);
			
			Element.grabClientX = e.clientX;
			Element.grabClientY = e.clientY;
			let ClientRect = GetElementRect(Element);
			Element.grabLocalX = Element.grabClientX - ClientRect.x;
			Element.grabLocalY = Element.grabClientY - ClientRect.y;
			Element.startDragX = ClientRect.x;
			Element.startDragY = ClientRect.y;
			
			//	convert element to absolute
			SetElementPosition( Element, Element.startDragX, Element.startDragY );

			Element.onmouseup = OnMouseUp;
			Element.onmousemove = OnMouseDrag;
			//	capture document mouse up in case the user drags off-window
			document.onmouseup = OnMouseUp;
			//	capture document mouse move for when the user moves the mouse so fast it goes off the element, and we don't get mousemove any more
			document.onmousemove = OnMouseDrag;
		};
		
		Element.onmousedown = OnMouseDown;
	}

	function CreateCard(Number,Suit)
	{
		var Card = document.createElement('div');
		Card.className = 'Card';
		
		var ImageUrl = 'Card_' + Suit.Name + Number + '.png';
		Card.style.backgroundImage = 'url("' + ImageUrl + '")';
		Card.appendChild( document.createTextNode( Number + ' ' + Suit.Name ) );
		
		MakeElementDraggable( Card );
		
		return { 'Number':Number, 'Suit':Suit, 'Element':Card };
	}

	function InitDeck(DeckElement)
	{
		DeckElement.GetDropPos = function(Element)
		{
			//	todo: can we accept this card?
			//	todo: get cascade position of other cards
			//	todo: get an offset from css
			let Offset = float2(0,0);
			let DeckRect = GetElementRect(DeckElement);
			console.log("Deck rect " + DeckRect.y);
			return float2( DeckRect.x+Offset.x, DeckRect.y+Offset.y );
		};
		
		DeckElement.OnDrop = function(Element)
		{
			SetElementParent( Element, DeckElement );
		};
	}

	function Init()
	{
		let DeckElements = document.getElementsByClassName("Deck");
		for ( var i=0;i<DeckElements.length;i++ )
			InitDeck(DeckElements[i]);
		//[].forEach.call( DeckElements, InitDeck );
		
		let Cards = [];
		Cards.push( CreateCard(7,$Club) );
		Cards.push( CreateCard(8,$Club) );
		Cards.push( CreateCard($Jack,$Club) );
		Cards.push( CreateCard(9,$Diamond) );
		Cards.push( CreateCard($Jack,$Diamond) );
		Cards.push( CreateCard($Queen,$Heart) );
		Cards.push( CreateCard($Jack,$Spade) );
		
		let DeckElement = document.getElementById('Deck');
		var x = 400;
		let PositionCard = function(Card)
		{
			x += 20;
			SetElementPosition( Card.Element, x, 20 );
		};
		Cards.forEach( PositionCard );
	}

	Init();

</script>

</body>
</html>

